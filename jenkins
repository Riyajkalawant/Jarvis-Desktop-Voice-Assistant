pipeline {
    agent any

    environment {
        DEPLOY_USER = "ubuntu"
        EC2_IP = "172.31.39.251"
        SSH_KEY_CREDENTIAL = "ubuntu (javacicd)"
        APP_DIR = "/home/ubuntu/jarvis-app"
    }

    stages {
        stage('Checkout Repo') {
            steps {
                checkout scm
            }
        }

        stage('Deploy on EC2') {
            steps {
                sshagent(credentials: [SSH_KEY_CREDENTIAL]) {

                    sh """
                    ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${EC2_IP} '
                        cd ${APP_DIR}
                        git pull
                        ${APP_DIR}/venv/bin/pip install -r requirements.txt
                        sudo systemctl restart jarvis.service
                        sudo systemctl status jarvis.service --no-pager
                    '
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Deployment Successful!"
        }
        failure {
            echo "Deployment Failed!"
        }
    }
}
